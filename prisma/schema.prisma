// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int         @id @unique @default(autoincrement())
  firstname     String
  lastname      String
  username      String      @unique
  email         String      @unique
  is_admin      Boolean     @default(false)
  password_hash String
  technician_id Int?        @unique
  technician    Technician? @relation(fields: [technician_id], references: [id])
  last_login    DateTime?
  created_at    DateTime    @default(now())
  updated_at    DateTime    @updatedAt
}

model Technician {
  id Int @id @default(autoincrement())

  shift     Int //1: shift 1, 2: shift 2, 3: nights
  unitTests UnitTest[]
  signoffs  UnitTest[] @relation("SignoffTechnician")

  User User?
}

model Job {
  id         Int      @id @unique @default(autoincrement())
  plc_mfg    String // PLC manufacturer for this job
  created_at DateTime @default(now())

  unitTests UnitTest[]
}

model UnitTest {
  id Int @id @default(autoincrement())

  test_type            TestType
  started_at           DateTime  @default(now())
  completed_at         DateTime?
  conditional_sign_off Boolean

  unit_id Int
  unit    Unit @relation(fields: [unit_id], references: [id])

  form_id Int
  form    TestForm @relation(fields: [form_id], references: [id])

  job_id Int
  job    Job @relation(fields: [job_id], references: [id])

  signoff_id  Int?
  signoff_by  Technician? @relation("SignoffTechnician", fields: [signoff_id], references: [id])
  technicians Technician[]
  results     TestResult[]

  @@index([started_at])
  @@index([completed_at])
  @@index([unit_id, job_id])
}

model Unit {
  id          Int         @id @default(autoincrement())
  unit_number Int         @unique
  unit_hand   Orientation
  model       String?
  created_at  DateTime    @default(now())
  unitTests   UnitTest[]
}

model TestForm {
  id         Int      @id @default(autoincrement())
  name       String
  version    Int
  is_active  Boolean  @default(true)
  created_at DateTime @default(now())

  testPoints       TestPoint[]
  unitTests        UnitTest[]
  TestSection      TestSection[]
  testFormVersions TestFormVersion[]

  @@unique([name, version])
}

model TestFormVersion {
  id         Int      @id @default(autoincrement())
  form_id    Int
  form       TestForm @relation(fields: [form_id], references: [id])
  changes    Json // Store what changed
  created_at DateTime @default(now())
  created_by Int // Link to user who made changes
}

model TestSection {
  id       Int    @id @default(autoincrement())
  name     String
  sequence Int

  testPoints TestPoint[]

  form_id Int
  form    TestForm @relation(fields: [form_id], references: [id])
}

model TestPoint {
  id          Int     @id @default(autoincrement())
  sequence    Int
  name        String
  description String?

  expected_value  Int?
  expected_values Int[]

  data_type DataType

  section_id Int
  section    TestSection @relation(fields: [section_id], references: [id])

  testFormId Int?
  TestForm   TestForm? @relation(fields: [testFormId], references: [id])

  results TestResult[]
}

model TestResult {
  id Int @id @default(autoincrement())

  actual_value        String?
  actual_number       Float?
  result              ResultStatus
  deficiency_category DeficiencyCategory

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  comments   String?
  created_by Int

  unit_test_id Int
  unitTest     UnitTest @relation(fields: [unit_test_id], references: [id])

  test_point_id Int
  testPoint     TestPoint @relation(fields: [test_point_id], references: [id])
}

enum DataType {
  boolean
  numeric
  text
  range
  date
}

enum ResultStatus {
  PASS
  FAIL
  INCOMPLETE
}

enum TestType {
  FULLWATER
  BYPASS
}

enum Orientation {
  Left
  Right
}

enum DeficiencyCategory {
  INCORRECT_INSTALLATION
  INCORRECT_TERMINATION
  FAULTY_COMPONENT
  MISSING_PART
  OUT_OF_STOCK
  POOR_WORKMANSHIP
  ADJUSTMENT
}
